{% extends "base.html" %}

{% block title %}Twoje Profile Głosowe{% endblock %}

{% block content %}
<div class="container animate-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Twoje Profile Głosowe</h2>
        <a href="{{ url_for('upload_voice') }}" class="btn btn-primary">
            <i class="bi bi-upload me-2"></i> Dodaj Nowy Profil
        </a>
    </div>

    {% if profiles %}
    <div class="accordion" id="profilesAccordion">
        {% for item in profiles %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading-{{ item.profile.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ item.profile.id }}" aria-expanded="false" aria-controls="collapse-{{ item.profile.id }}">
                    <strong>{{ item.profile.name }}</strong> (ID: {{ item.profile.id }})
                </button>
            </h2>
            <div id="collapse-{{ item.profile.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ item.profile.id }}" data-bs-parent="#profilesAccordion">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>Data Utworzenia:</strong> {{ item.profile.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</p>
                            <p><strong>Częstotliwość:</strong> {{ item.profile.sample_rate or 'N/A' }} Hz</p>
                            <p><strong>Liczba Próbek:</strong> {{ item.profile.num_samples or 'N/A' }}</p>
                            <p><strong>RMS (dB):</strong> {{ item.profile.rms_db or 'N/A' }} dB</p>
                            <p><strong>ZCR:</strong> {{ item.profile.zcr or 'N/A' }}</p>
                            <p><strong>SNR (dB):</strong> {{ item.profile.snr_db or 'N/A' }} dB</p>
                            <p><strong>Status Treningu ASR:</strong> 
                                <span id="status-{{ item.profile.id }}" class="badge {% if item.asr_trained %}bg-success{% else %}bg-warning text-dark{% endif %}">
                                    {% if item.asr_trained %}
                                    Gotowy
                                    {% else %}
                                    Nieprzetrenowany
                                    {% endif %}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <audio id="audio-{{ item.profile.id }}" controls class="w-100">
                                    <source src="{{ url_for('serve_processed_audio', filename=item.profile.audio_file) }}" type="audio/mpeg">
                                    Twoja przeglądarka nie obsługuje elementu audio.
                                </audio>
                            </div>
                            <div class="mb-3">
                                <div class="progress mb-2">
                                    <div id="progress-bar-{{ item.profile.id }}" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small id="time-elapsed-{{ item.profile.id }}">Czas: 0s</small>
                                    <small id="epoch-{{ item.profile.id }}">Epoka: 0 z 10</small>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap">
                                <a href="{{ url_for('edit_profile', profile_id=item.profile.id) }}" class="btn btn-warning btn-sm me-2 mb-2">
                                    <i class="bi bi-pencil-square"></i> Edytuj
                                </a>
                                <form action="{{ url_for('delete_profile', profile_id=item.profile.id) }}" method="POST" class="d-inline me-2 mb-2">
                                    <button type="submit" class="btn btn-danger btn-sm delete-profile-btn">
                                        <i class="bi bi-trash-fill"></i> Usuń
                                    </button>
                                </form>
                                <button type="button" class="btn btn-success btn-sm start-training-btn me-2 mb-2" data-profile-id="{{ item.profile.id }}">
                                    <i class="bi bi-robot"></i> Trenuj
                                </button>
                                <button id="pause-{{ item.profile.id }}" type="button" class="btn btn-warning btn-sm me-2 mb-2" disabled>
                                    <i class="bi bi-pause-circle-fill"></i> Pauza
                                </button>
                                <button class="btn btn-info btn-sm play-audio-btn me-2 mb-2" data-audio-id="audio-{{ item.profile.id }}">
                                    <i class="bi bi-play-circle-fill"></i> Odtwórz/Pauza
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card animate-in">
        <div class="card-body text-center">
            <h5 class="card-title">Brak Profili Głosowych</h5>
            <p class="card-text">Nie masz jeszcze żadnych profili głosowych. Dodaj nowy profil, aby rozpocząć.</p>
            <a href="{{ url_for('upload_voice') }}" class="btn btn-primary">Dodaj Profil</a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal dla szczegółów treningu -->
<div class="modal fade" id="trainingModal" tabindex="-1" aria-labelledby="trainingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="trainingModalLabel">Szczegóły Treningu</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Status:</strong> <span id="modal-status">N/A</span></p>
        <p><strong>Postęp:</strong> <span id="modal-progress">0%</span></p>
        <p><strong>Epoka:</strong> <span id="modal-epoch">0 z 10</span></p>
        <p><strong>Czas Trwania:</strong> <span id="modal-time-elapsed">0s</span></p>
        <div class="progress mb-3">
          <div id="modal-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <h5>Metryki:</h5>
        <ul>
            <li><strong>WER:</strong> <span id="modal-wer">0.00%</span></li>
            <li><strong>CER:</strong> <span id="modal-cer">0.00%</span></li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" id="modal-pause-resume-btn" class="btn btn-warning" disabled>
            <i class="bi bi-pause-circle-fill"></i> Pauza
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
      </div>
    </div>
  </div>
</div>

<script>
// Obiekt globalny do monitorowania postępów treningu
const trainingProgress = {};

// Funkcja pomocnicza do generowania statusu jako badge
function statusBadge(status) {
    if (status.includes("Zakończony")) {
        return '<span class="badge bg-success">Zakończony</span>';
    } else if (status.includes("Błąd")) {
        return '<span class="badge bg-danger">Błąd podczas treningu</span>';
    } else if (status.includes("Trening w toku")) {
        return '<span class="badge bg-info">Trening w toku</span>';
    } else if (status.includes("Trening wstrzymany")) {
        return '<span class="badge bg-warning text-dark">Trening wstrzymany</span>';
    }
    return `<span class="badge bg-secondary">${status}</span>`;
}

// Funkcje pomocnicze do aktualizacji elementów HTML
function updateElement(id, content) {
    const element = document.getElementById(id);
    if (element) {
        element.innerHTML = content;
    }
}

function updateProgressBar(id, progress) {
    const progressBar = document.getElementById(id);
    if (progressBar) {
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.innerHTML = `${progress}%`;
    }
}

function updateStatus(id, status) {
    const statusElement = document.getElementById(id);
    if (statusElement) {
        statusElement.innerHTML = status;
    }
}

function enablePauseButton(id) {
    const pauseButton = document.getElementById(id);
    if (pauseButton) {
        pauseButton.disabled = false;
        pauseButton.addEventListener('click', () => togglePauseResume(id));
    }
}

function disablePauseResumeButton() {
    const modalPauseResumeButton = document.getElementById('modal-pause-resume-btn');
    if (modalPauseResumeButton) {
        modalPauseResumeButton.disabled = true;
    }
}

// Funkcja do zarządzania przyciskiem pauzy/wznawiania w modal
function handlePauseResumeButton(profileId, isPaused) {
    const modalPauseResumeButton = document.getElementById('modal-pause-resume-btn');
    const profilePauseButton = document.getElementById(`pause-${profileId}`);

    if (modalPauseResumeButton && profilePauseButton) {
        modalPauseResumeButton.disabled = false;
        profilePauseButton.disabled = false;

        if (isPaused) {
            modalPauseResumeButton.innerHTML = '<i class="bi bi-play-circle-fill"></i> Wznów';
            profilePauseButton.innerHTML = '<i class="bi bi-play-circle-fill"></i> Wznów';
        } else {
            modalPauseResumeButton.innerHTML = '<i class="bi bi-pause-circle-fill"></i> Pauza';
            profilePauseButton.innerHTML = '<i class="bi bi-pause-circle-fill"></i> Pauza';
        }

        // Usunięcie wcześniejszych event listenerów, aby uniknąć wielokrotnego przypisywania
        modalPauseResumeButton.replaceWith(modalPauseResumeButton.cloneNode(true));
        profilePauseButton.replaceWith(profilePauseButton.cloneNode(true));

        // Ponowne przypisanie event listenerów po klonowaniu
        document.getElementById('modal-pause-resume-btn').addEventListener('click', () => {
            togglePauseResume(profileId);
        });

        document.getElementById(`pause-${profileId}`).addEventListener('click', () => {
            togglePauseResume(profileId);
        });
    }
}

// Funkcja do rozpoczynania treningu
function startTraining(profileId) {
    const statusId = `status-${profileId}`;
    const progressBarId = `progress-bar-${profileId}`;
    const timeElapsedId = `time-elapsed-${profileId}`;
    const epochId = `epoch-${profileId}`;
    const pauseButtonId = `pause-${profileId}`;

    // Aktualizacja początkowego statusu
    updateElement(statusId, '<span class="badge bg-info">Trening w toku...</span>');
    updateProgressBar(progressBarId, 0);
    updateElement(timeElapsedId, 'Czas: 0s');
    updateElement(epochId, 'Epoka: 0 z 10');
    document.getElementById(pauseButtonId).disabled = false;

    // Wysłanie żądania do serwera o rozpoczęcie treningu
    fetch(`/train_asr_model/${profileId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            console.log(data.message);
            startSSE(profileId);  // Rozpoczyna monitorowanie postępu
        } else if (data.error) {
            console.error('Błąd:', data.error);
            updateElement(statusId, '<span class="badge bg-danger">Błąd podczas treningu</span>');
            updateProgressBar(progressBarId, 0);
        }
    })
    .catch((error) => {
        console.error('Błąd podczas rozpoczynania treningu:', error);
        updateElement(statusId, '<span class="badge bg-danger">Błąd podczas treningu</span>');
        updateProgressBar(progressBarId, 0);
    });
}

// Monitorowanie postępu za pomocą SSE
function startSSE(profileId, modal = false) {
    const source = new EventSource(`/training_status/${profileId}`);

    source.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const progress = data.progress;
        const status = data.status;
        const currentEpoch = data.current_epoch;
        const totalEpochs = data.total_epochs;
        const timeElapsed = data.time_elapsed;
        const loss = data.loss;
        const isPaused = data.is_paused;

        // Aktualizacja postępu w tabeli
        updateProgressBar(`progress-bar-${profileId}`, progress);
        updateStatus(`status-${profileId}`, statusBadge(status));
        updateElement(`time-elapsed-${profileId}`, `Czas: ${timeElapsed}s`);
        updateElement(`epoch-${profileId}`, `Epoka: ${currentEpoch} z ${totalEpochs}`);
        updateElement(`loss-${profileId}`, `Strata: ${loss}`);

        // Aktualizacja modal
        if (modal) {
            updateElement('modal-status', status);
            updateElement('modal-progress', `${progress}%`);
            updateProgressBar('modal-progress-bar', progress);
            updateElement('modal-epoch', `Epoka: ${currentEpoch} z ${totalEpochs}`);
            updateElement('modal-time-elapsed', `${timeElapsed}s`);
            updateElement('modal-loss', loss);
            handlePauseResumeButton(profileId, isPaused);
        }

        // Zakończenie po osiągnięciu 100% lub błędzie
        if (progress >= 100 || status.includes('Błąd')) {
            source.close();
            if (modal) {
                document.getElementById('modal-pause-resume-btn').disabled = true;
            }
        }
    };

    source.onerror = function(error) {
        console.error("Błąd SSE:", error);
        source.close();
        if (modal) {
            document.getElementById('modal-pause-resume-btn').disabled = true;
        }
        alert("Wystąpił błąd podczas monitorowania postępu treningu.");
    };
}

// Zarządzanie stanem pauzy i wznowienia treningu
function togglePauseResume(profileId) {
    const isPaused = trainingProgress[profileId].is_paused;

    const action = isPaused ? 'resume_training' : 'pause_training';

    fetch(`/${action}/${profileId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                console.log(data.message);
                trainingProgress[profileId].is_paused = !isPaused;
                handlePauseResumeButton(profileId, trainingProgress[profileId].is_paused);
            } else if (data.error) {
                console.error('Błąd:', data.error);
                alert(`Błąd podczas ${isPaused ? 'wznawiania' : 'wstrzymywania'} treningu: ${data.error}`);
            }
        })
        .catch((error) => {
            console.error(`Błąd podczas ${isPaused ? 'wznawiania' : 'wstrzymywania'} treningu:`, error);
            alert(`Błąd podczas ${isPaused ? 'wznawiania' : 'wstrzymywania'} treningu.`);
        });
}

// Inicjalizacja przycisków i obsługa audio
document.addEventListener('DOMContentLoaded', () => {
    const startTrainingButtons = document.querySelectorAll('.start-training-btn');
    startTrainingButtons.forEach(button => {
        button.addEventListener('click', () => {
            const profileId = button.getAttribute('data-profile-id');
            startTraining(profileId);
        });
    });

    const playAudioButtons = document.querySelectorAll('.play-audio-btn');
    playAudioButtons.forEach(button => {
        button.addEventListener('click', () => {
            const audioId = button.getAttribute('data-audio-id');
            const audioElement = document.getElementById(audioId);

            if (audioElement.paused) {
                audioElement.play();
                button.innerHTML = '<i class="bi bi-pause-circle-fill"></i> Pauza';
            } else {
                audioElement.pause();
                button.innerHTML = '<i class="bi bi-play-circle-fill"></i> Odtwórz';
            }

            audioElement.onended = () => {
                button.innerHTML = '<i class="bi bi-play-circle-fill"></i> Odtwórz';
            };
        });
    });
});
</script>

{% endblock %}
